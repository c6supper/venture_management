@using Ext.Net
@using Ext.Net.MVC
@{
    ViewBag.Title = "隐患预警管理";
    Layout = "~/Views/Shared/_BaseLayout.cshtml";
    var X = Html.X();
}

@section headtag
{
    <script>
        var template = 'color:{0};';

        var emptyCheck = function(value, meta) {
            meta.style = Ext.String.format(template, (value === "") ? "green" : "red");
            if (value === "")
                value = "不能为空";
            return value;
        };

        var change = function(value, meta) {
            meta.style = Ext.String.format(template, (value > 0) ? "green" : "red");
            return value;
        };

        var beforeEdit = function(editor, e) {
            if (e.field !== "DisplayName" && e.filed !== "Email" && e.filed !== "Status" &&
                e.field !== "Status")
                return false;
            return true;
        };

        var addRecord = function(grid) {
            var r = Ext.create({
                Status: "已验证"
            });
            grid.store.insert(0, r);
            form.getForm().reset();
        };
    </script>
}

    

@section menu
{
    @(
        X.GridPanel()
            .Title("隐患列表")
            .ID("ThreatGrid")
            .Frame(true)
            .Height(400)
            .TopBar(
                Html.X().Toolbar()
                    .Items(
                        Html.X().Button()
                            .Text("保存")
                            .Icon(Icon.Disk)
                            .DirectEvents(de =>
                            {
                                de.Click.Url = Url.Action("UpdateThreatCases");
                                de.Click.ExtraParams.Add(new Parameter
                                {
                                    Name = "data",
                                    Value = "this.up('grid').store.getChangedData()",
                                    Mode = ParameterMode.Raw,
                                    Encode = true
                                });
                            }),
                            
                        Html.X().Button()
                            .Text("增加")
                            .Icon(Icon.UserAdd)
                            .Handler("addRecord(App.ThreatGrid);")
                            
                        )
                    )
            .Store(
                Html.X().Store()
                    .ID("ThreatGridStore")
                    .Proxy(Html.X().AjaxProxy()
                        .Url(Url.Action("Read"))
                        .Reader(Html.X().JsonReader().Root("data"))
                    )
                    .RemoteSort(true)
                    .PageSize(15)
                    .Model(
                            Html.X().Model()
                                .IDProperty("ThreatId")
                                .Fields(
                                    Html.X().ModelField().Name("ThreatId"),
                                    Html.X().ModelField().Name("ThreatName"),
                                    Html.X().ModelField().Name("DisplayName"),
                                    Html.X().ModelField().Name("Email"),
                                    Html.X().ModelField().Name("Mobile"),
                                    Html.X().ModelField().Name("RegistrationTime").Type(ModelFieldType.Date),
                                    Html.X().ModelField().Name("LoginTime").Type(ModelFieldType.Date),
                                    Html.X().ModelField().Name("LoginIP"),
                                    Html.X().ModelField().Name("Status")
                                )
                            )
                    )
                    
            .ColumnModel(
                Html.X().Column().DataIndex("ThreatId").Text("Id").Hidden(true),
                Html.X().ComponentColumn().DataIndex("ThreatName").Text("隐患名").EmptyCellText("不能为空")
                    .OverOnly(true).Editor(true).Component(Html.X().TextField()
                    .AllowBlank(false).EmptyText("隐患名最少五个字")),
                Html.X().ComponentColumn().DataIndex("DisplayName").Text("昵称")
                    .OverOnly(true).Editor(true).Component(Html.X().TextField()),
                    Html.X().ComponentColumn().DataIndex("Email").Text("Email").EmptyCellText("不能为空")
                    .OverOnly(true).Editor(true).Component(Html.X().TextField()
                        .AllowBlank(false).StandardVtype(ValidationType.Email)),
                Html.X().ComponentColumn().DataIndex("Mobile").Text("手机号").EmptyCellText("不能为空")
                    .OverOnly(true).Editor(true).Component(Html.X().TextField()
                        .AllowBlank(false).StandardVtype(ValidationType.AlphaNum)),
                Html.X().DateColumn().DataIndex("RegistrationTime").Text("注册时间").Format("yyyy-MM-dd"),
                Html.X().DateColumn().DataIndex("LoginTime").Text("最近登录时间").Format("yyyy-MM-dd"),
                Html.X().Column().DataIndex("LoginIP").Text("最近登录的IP"),
                Html.X().ComponentColumn().DataIndex("Status").Text("状态")
                    .UnpinEvents("collapse").PinEvents("expand")
                    .OverOnly(true).Editor(true).Component(Html.X().ComboBox()
                        .Items(
                                    new ListItem("未验证"),
                                    new ListItem("管理员未确认"),
                                    new ListItem("锁定"),
                                    new ListItem("已验证")
                                )
                    ))
                    
            .Plugins(
                    X.FilterHeader()
                )
                
            .BottomBar(
                Html.X().PagingToolbar()
                    .BeforePageText("页")
                    .AfterPageText("第{0}页")
                    .DisplayInfo(true)
                    .DisplayMsg("显示隐患预警 {0} - {1} 共 {2}")
                    .EmptyMsg("没有隐患预警"))
    )
}