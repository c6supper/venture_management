@using Ext.Net
@using Ext.Net.MVC
@using InputType = Ext.Net.InputType
@{
    ViewBag.Title = "新建隐患预警";
    Layout = "~/Views/Shared/_BaseLayout.cshtml";
    var X = Html.X();
}

@section headtag
{
    <style>
        .search-item {
            font          : normal 11px tahoma, arial, helvetica, sans-serif;
            padding       : 3px 10px 3px 10px;
            border        : 1px solid #fff;
            border-bottom : 1px solid #eeeeee;
            white-space   : normal;
            color         : #555;
        }
        
        .search-item h3 {
            display     : block;
            font        : inherit;
            font-weight : bold;
            color       : #222;
            margin      :0px;
        }

        .search-item h3 span {
            float       : right;
            font-weight : normal;
            margin      : 0 0 5px 5px;
            width       : 100px;
            display     : block;
            clear       : none;
        } 
        
        p { width: 650px; }
        
        .ext-ie .x-form-text { position : static !important; }
    </style>
    <script>
        var SelectProject = function(record)
        {
            App.ProjectLocationId.setValue(record.get('ProjectLocation'));
            App.ThreatCaseLocation.setValue(record.get('ProjectLocation'));
            App.OrganizationName.setValue(record.get('OrganizationName'));
        }

        var CalcRisk = function() {
            var risk = App.ThreatCaseSeverityId.getValue() * App.ThreatCasePassibilityId.getValue();
            App.ThreatCaseRiskId.setValue(risk);
            if (risk >= 100)
                App.ThreatCaseLevelId.setValue("重大事故隐患");
            else if(risk >= 70)
                App.ThreatCaseLevelId.setValue("较大事故隐患");
            else
                App.ThreatCaseLevelId.setValue("一般事故隐患");
        };

        var CreateThreatCase = function(extraParams) {
            if (!this.up('form').isValid())
                return false;
            Ext.ComponentQuery.query('checkboxgroup').forEach(function(item, index) {
                if (item.isXType('checkboxgroup', true)) {
                    var count = 0;
                    extraParams['groups1[' + index + '].FieldLabel'] = item.fieldLabel;
                    Ext.ComponentQuery.query('checkbox', item).forEach(function(innerItem) {
                        if (innerItem.isXType('checkbox') && innerItem.checked) {
                            extraParams['groups1[' + index + '].CheckedItems[' + count + '].BoxLabel'] = innerItem.boxLabel;
                            count++;
                        }
                    });
                }
            });

            Ext.ComponentQuery.query('radiogroup').forEach(function(item, index) {
                if (item.isXType('radiogroup', true)) {
                    var count = 0;
                    extraParams['groups2[' + index + '].FieldLabel'] = item.fieldLabel;
                    Ext.ComponentQuery.query('checkbox', item).forEach(function(innerItem) {
                        if (innerItem.isXType('radio') && innerItem.checked) {
                            extraParams['groups2[' + index + '].CheckedItems[' + count + '].BoxLabel'] = innerItem.boxLabel;
                            count++;
                        }
                    });
                }
            });
            return true;
        };
    </script>
}

@section menu
{
    @(X.FormPanel()
          .ID("ThreatCasePanel")
          .Title("隐患申报")
          .Frame(true)
          .Url(Url.Action("Submit"))
          .Width(600)
          .BodyPadding(10)
          .FieldDefaults(fd =>
          {
              fd.LabelWidth = 110;
              fd.LabelStyle = "color:green;padding-left:4px;";
          })
          .Buttons(
              X.Button()
                  .ID("CreateButton")
                  .Text("预警")
                  .Icon(Icon.Disk)
                  .Handler("this.up('form').submit();"),
              //.DirectEvents(de =>
              //{
              //    de.Click.Url = Url.Action("CreateThreatCase");
              //    de.Click.Before = "CreateThreatCase.call(this, extraParams);";
              //}),

              X.Button()
                  .Text("取消")
                  .OnClientClick("this.up('form').reset();")
          )
          .Items(
              X.Container()
                  .Layout(LayoutType.HBox)
                  .MarginSpec("0 0 10"),

              X.FieldSet()
                  .Title("工程信息")
                  .ID("ProjectInfo")
                  .Layout(LayoutType.Anchor)
                  .Collapsible(true)
                  .Collapsed(false)
                  .DefaultAnchor("100%")
                  .Items(
                      X.ComboBox()
                          .ID("ProjectId")
                          .FieldLabel("工程")
                          .EmptyText("请输入关键字或*显示全部")
                          .DisplayField("ProjectName")
                          .ValueField("ProjectId")
                          .TypeAhead(true)
                          .PageSize(15)
                          .HideBaseTrigger(true)
                          .MinChars(0)
                          .TriggerAction(TriggerAction.All)
                          .ListConfig(Html.X().BoundList()
                              .LoadingText("搜索中...")
                              .ItemTpl(Html.X().XTemplate()
                                  .Html(@<text>
                                            <div class="search-item">
                                                <h3><span>{ProjectName}</span></h3>
                                                {ProjectLocation}
                                            </div>
                                         </text>)
                              ))
                          .Store(Html.X().Store()
                              .AutoLoad(true)
                              .Proxy(Html.X().AjaxProxy()
                                  .Url(Url.Action("GetAllProjects"))
                                  .ActionMethods(am => am.Read = HttpMethod.POST)
                                  .Reader(Html.X().JsonReader().Root("data"))
                              )
                              .Model(Html.X().Model()
                                  .Fields(
                                      Html.X().ModelField().Name("ProjectId"),
                                      Html.X().ModelField().Name("ProjectName"),
                                      Html.X().ModelField().Name("ProjectLocation"),
                                      Html.X().ModelField().Name("OrganizationName")
                                  )
                              )
                          )
                          .Listeners(ls => ls.Select.Handler = "SelectProject(records[0]);"),
                      X.TextField().ID("ProjectLocationId").DataIndex("ProjectLocation").FieldLabel("施工地点")
                  ),

              X.FieldSet()
                  .Title("施工方信息")
                  .Layout(LayoutType.Anchor)
                  .Collapsible(true)
                  .Collapsed(false)
                  .DefaultAnchor("100%")
                  .Items(
                      X.TextField().ID("OrganizationName").DataIndex("OrganizationName").FieldLabel("施工方")
                  ),

              X.FieldSet()
                  .Title("工程负责人")
                  .Layout(LayoutType.Anchor)
                  .Collapsible(true)
                  .Collapsed(false)
                  .DefaultAnchor("100%")
                  .Items(
                      X.TextField().DataIndex("UserName").FieldLabel("责任人"),
                      X.TextField().DataIndex("Email").FieldLabel("邮件"),
                      X.TextField().DataIndex("Mobile").FieldLabel("联系方式")
                  ),

              X.FieldSet()
                  .Title("隐患信息")
                  .Layout(LayoutType.Anchor)
                  .Collapsible(true)
                  .Collapsed(false)
                  .DefaultAnchor("100%")
                  .Items(
                      X.Container()
                          .Layout(LayoutType.Column)
                          .MarginSpec("0 0 10")
                          .Items(
                              X.TextField().ID("ThreatCaseLocation").DataIndex("ThreatCaseLocation").FieldLabel("隐患发现地"),
                              X.DateField().ID("ThreatCaseFoundTime").DataIndex("ThreatCaseFoundTime").FieldLabel("隐患发现时间")
                                .Value(DateTime.Now)),
                      X.TextArea().DataIndex("ThreatCaseDescription").FieldLabel("隐患描述").Height(60),
                      X.Container()
                          .Layout(LayoutType.Column)
                          .MarginSpec("0 0 10")
                          .Items(
                              X.ComboBox()
                                  .FieldLabel("隐患大类")
                                  .ID("ThreatCategory")
                                  .TypeAhead(true)
                                  .QueryMode(DataLoadMode.Local)
                                  .ForceSelection(true)
                                  .TriggerAction(TriggerAction.All)
                                  .DisplayField("CategoryName")
                                  .ValueField("CategoryName")
                                  .Listeners(ls =>
                                      ls.Select.Handler = "App.ThreatType.clearValue(); App.ThreatType.getStore().load();")

                                  .EmptyText("Loading...")
                                  .ValueNotFoundText("Loading...")
                                  .Store(Html.X().Store()
                                      .AutoLoad(true)
                                      .Model(Html.X().Model()
                                          .IDProperty("ThreatCategoryId")
                                          .Fields(
                                              new ModelField("CategoryName", ModelFieldType.String) {Mapping = "CategoryName"}
                                          )
                                      )
                                      .Proxy(Html.X().AjaxProxy()
                                          .Url(Url.Action("GetThreatCategory"))
                                          .Reader(Html.X().JsonReader().Root("data"))
                                      )
                                      .Listeners(ls =>
                                      {
                                          ls.Load.Handler = @"var combo = App.ThreatCategory;combo.setValue(records[0].get(combo.valueField));";
                                      })
                                  ),
                              X.ComboBox()
                                  .FieldLabel("隐患小类")
                                  .ID("ThreatType")
                                  .TypeAhead(true)
                                  .QueryMode(DataLoadMode.Local)
                                  .ForceSelection(true)
                                  .TriggerAction(TriggerAction.All)
                                  .DisplayField("TypeName")
                                  .ValueField("TypeName")
                                  .EmptyText("Loading...")
                                  .ValueNotFoundText("Loading...")
                                  .Listeners(ls=>ls.Select.Handler="App.ThreatCaseCauseId.setValue(records[0].get('Cause'));App.ThreatCaseSuggestionId.setValue(records[0].get('Correction'));")
                                  .Store(Html.X().Store()
                                      .AutoLoad(true)
                                      .Model(Html.X().Model()
                                          .IDProperty("ThreatTypeId")
                                          .Fields(
                                              new ModelField("TypeName", ModelFieldType.String) {Mapping = "TypeName"},
                                              new ModelField("Cause", ModelFieldType.String) {Mapping = "Cause"},
                                              new ModelField("Correction", ModelFieldType.String) {Mapping = "Correction"}
                                          )
                                      )
                                      .Proxy(Html.X().AjaxProxy()
                                          .Url(Url.Action("GetThreatType"))
                                          .Reader(Html.X().JsonReader().Root("data"))
                                      )
                                      .Parameters(ps =>
                                          ps.Add(new StoreParameter("category", "App.ThreatCategory.getValue()", ParameterMode.Raw))
                                      )
                                      .Listeners(ls =>
                                      {
                                          ls.Load.Handler = @"var combo = App.ThreatType;
                                            combo.setValue(records[0].get(combo.valueField));App.ThreatCaseCauseId.setValue(records[0].get('Cause'));
                                            App.ThreatCaseSuggestionId.setValue(records[0].get('Correction'));";
                                      })
                                  )),
                        X.Container()
                        .Layout(LayoutType.Column)
                        .MarginSpec("0 0 10")
                        .Items(
                            X.ComboBox()
                                .FieldLabel("严重性等级")
                                .ID("ThreatCaseSeverityId")
                                .QueryMode(DataLoadMode.Local)
                                .TriggerAction(TriggerAction.All)
                                .SelectOnFocus(true)
                                .EmptyText("")
                                .Listeners(ls=>ls.Select.Handler="CalcRisk();")
                                .Items(
                                    new ListItem("灾难的",10),
                                    new ListItem("严重的",7),
                                    new ListItem("轻度的",4),
                                    new ListItem("轻微的",1)
                                ),
                                X.ComboBox()
                                .FieldLabel("可能性等级")
                                .ID("ThreatCasePassibilityId")
                                .QueryMode(DataLoadMode.Local)
                                .TriggerAction(TriggerAction.All)
                                .SelectOnFocus(true)
                                .EmptyText("")
                                .Listeners(ls=>ls.Select.Handler="CalcRisk();")
                                .Items(
                                    new ListItem("很可能",10),
                                    new ListItem("可能的",7),
                                    new ListItem("有可能",5),
                                    new ListItem("不太可能",3),
                                    new ListItem("不可能",1)
                                )
                            ),
                            
                            X.Container()
                            .Layout(LayoutType.Column)
                            .MarginSpec("0 0 10")
                            .Items(
                                X.TextField()
                                    .FieldLabel("隐患风险评价指数")
                                    .ID("ThreatCaseRiskId")
                                    .EmptyText("")
                                    .ReadOnly(true),
                                    
                                X.TextField()
                                    .FieldLabel("隐患分级")
                                    .ID("ThreatCaseLevelId")
                                    .EmptyText("")
                                    .ReadOnly(true)
                                ),
                        X.TextArea().ID("ThreatCaseCauseId").DataIndex("ThreatCaseCause").FieldLabel("可能的原因").Height(20),                            
                        X.TextArea().DataIndex("ThreatCaseCertification").FieldLabel("资质证件使用情况").Height(40),
                        X.TextArea().DataIndex("ThreatCaseCurrentSecurity").FieldLabel("现有安全设施情况").Height(40),
                        X.TextArea().ID("ThreatCaseSuggestionId").DataIndex("ThreatCaseSuggestion").FieldLabel("整改措施建议").Height(60)
                    )
                )
          )
}