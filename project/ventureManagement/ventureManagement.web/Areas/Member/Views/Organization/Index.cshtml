@{
    ViewBag.Title = "集团组织结构";
    Layout = "~/Views/Shared/_BaseLayout.cshtml";
    var X = Html.X();
}

@section headtag
{
    <script>
        var resetCreateForm = function() {
            App.SubordinateDepartment.setValue('');
            App.Description.setValue('');
            App.newOrganization.hide();
        };
    </script>
}

    

@section menu
{
    @(X.FormPanel()
          .Title("")
          .AutoScroll(true)
          .Height(400)
          .BodyPadding(5)
          .ManageHeight(true)
          .Layout(LayoutType.Column)
          .FieldDefaults(fd => {
                                   fd.LabelAlign = LabelAlign.Left;
                                   fd.MsgTarget = MessageTarget.Side;
          })
          .Items(
              X.FieldSet()
                  .Hidden(true)
                  .ID("newOrganization")
                  .Title("新增部门信息")
                  .ColumnWidth(0.2)
                  .MarginSpec("10 10 10 10")
                  .Defaults(d => {
                                     d.Add(new Parameter("Width", "240"));
                                     d.Add(new Parameter("LabelWidth", "90"));
                  })
                  .Items(
                       X.TextField()
                          .ReadOnly(true)
                          .Hidden(true)
                          .ID("SuperiorDepartmentId")
                          .Name("organizationId")
                          .FieldLabel("上级部门Id"),
                      X.TextField()
                          .ReadOnly(true)
                          .ID("SuperiorDepartment")
                          .Name("organizationName")
                          .EmptyText("请选择上级部门")
                          .FieldLabel("上级部门"),
                      X.TextField()
                          .ID("SubordinateDepartment")
                          .Name("SubordinateDepartment")
                          .EmptyText("请输入新建部门名")
                          .FieldLabel("下级部门"),
                      X.TextField()
                          .ID("Description")
                          .Name("Description")
                          .FieldLabel("备注"),  
                      X.InfoPanel()
                          .Layout(LayoutType.HBox)
                          .LayoutConfig(new HBoxLayoutConfig { Align = HBoxAlign.Middle}) 
                          .Items(              
                              X.Button()
                                    .Text("提交")
                                    .Margin(10)
                                    .Width(80)
                                    .Icon(Icon.Lightning)
                                    .FormBind(true)
                                    .ColSpan(1)
                                    .DirectEvents(de => {
                                        de.Click.Url = Url.Action("CreateOrganization");
                                        de.Click.ExtraParams.Add(new Parameter("superiorDepartmentId", "App.SuperiorDepartmentId.getValue()", ParameterMode.Raw));
                                        de.Click.ExtraParams.Add(new Parameter("subordinateDepartment", "App.SubordinateDepartment.getValue()", ParameterMode.Raw));
                                        de.Click.ExtraParams.Add(new Parameter("description", "App.Description.getValue()", ParameterMode.Raw));
                                        de.Click.Success = "resetCreateForm();";
                                    }),
                              X.Button()
                                  .Text("取消")
                                  .Width(80)
                                  .Margin(10)
                                  .ColSpan(1)
                                  .Icon(Icon.Lightning)
                                  .FormBind(true)
                                  .Handler("resetCreateForm();")
                          )
                  ),

              X.TreePanel()
                  .ID("OrganizationTreePanel")
                  .Title("集团组织结构")
                  .ColumnWidth(0.7)
                  .Collapsible(false)
                  .UseArrows(true)
                  .RootVisible(true)
                  .MultiSelect(true)
                  .SingleExpand(true)
                  .FolderSort(true)
                  .AutoScroll(true)
                  .TopBar(Html.X().Toolbar()
                      .Items(
                          Html.X().Button()
                          .Text("新增")
                          .Icon(Icon.CommentAdd)
                          .Handler("App.newOrganization.show();")
                          //Html.X().Button()
                          //.Text("删除")
                          //.Icon(Icon.CommentDelete)
                          //.DirectEvents(de =>
                          //{
                          //    de.Click.Url = Url.Action("DeleteOrganization");
                          //    de.Click.ExtraParams.Add(new Parameter("organizationId", "App.SuperiorDepartmentId.getValue()", ParameterMode.Raw));
                          //    de.Click.Success = "resetCreateForm();";
                          //    de.Click.Confirmation.ConfirmRequest = true;
                          //    de.Click.Confirmation.BeforeConfirm = "config.confirmation.message = '是否确定要删除[' + App.SuperiorDepartment.getValue() + ']及其子部门'";
                          //})
                      )
                  )
                  .Fields(
                      X.ModelField().Name("organizationId"),
                      X.ModelField().Name("organizationName"),
                      X.ModelField().Name("Description")
                  )
                  .ColumnModel(    
                      X.TreeColumn()
                          .Flex(0)
                          .Hidden(true)
                          .Text("部门Id")
                          .DataIndex("organizationId"),
                          
                      X.TreeColumn()
                          .Flex(3)
                          .Text("部门")
                          .DataIndex("organizationName"),
                    
                      X.TreeColumn()
                          .Flex(2)
                          .Text("备注")
                          .DataIndex("Description")                  
                  )
                  .Listeners(l => l.SelectionChange.Handler = "if (selected[0]) { this.up('form').getForm().loadRecord(selected[0]); }")
                  .Root(Model)
          ))
}